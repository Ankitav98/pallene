/* This file was generated by the Titan compiler. Do not edit by hand */
/* Indentation and formatting courtesy of titan-compiler/pretty.lua */

#include <string.h>

#include "tcore.h"

#include "lua.h"
#include "lauxlib.h"
#include "lualib.h"

#include "lapi.h"
#include "lfunc.h"
#include "lgc.h"
#include "lobject.h"
#include "lstate.h"
#include "lstring.h"
#include "ltable.h"
#include "lvm.h"

#include "math.h"

static lua_Number function_sum_titan(
    lua_State * L,
    Table * x1 /* arr */,
    lua_Integer x2 /* nrep */
){
    CClosure * x3 = clCvalue(s2v(L->ci->func));
    Table * x4 /* upvalue table */ = hvalue(&x3->upvalue[0]);
    TValue * x5 /* upvalue array */ = x4->array;
    (void)x5;
    {
        lua_Number x6 /* s */ = 0x0p+0 /*0.000000*/;
        lua_Integer x7 /* start */ = 1;
        lua_Integer x8 /* finish */ = x2;
        lua_Integer x9 /* inc */ = 1;
        while ((x9 >= 0 ? x7 <= x8 : x7 >= x8)) {
            lua_Integer x10 /* rep */ = x7;
            (void) x10;
            {
                lua_Integer x12 = luaH_getn(x1);
                lua_Integer x11 /* start */ = 1;
                lua_Integer x13 /* finish */ = x12;
                lua_Integer x14 /* inc */ = 1;
                while ((x14 >= 0 ? x11 <= x13 : x11 >= x13)) {
                    lua_Integer x15 /* i */ = x11;
                    (void) x15;
                    {
                        lua_Unsigned x16 /* ui */ = ((lua_Unsigned)x15) - 1;
                        const TValue * x17 /* arrslot */;
                        if (TITAN_LIKELY(x16 < x1->sizearray)) {
                            x17 = &x1->array[x16];
                        } else {
                            x17 = luaH_getint(x1, x15);
                        }
                        if (TITAN_UNLIKELY(!ttisfloat(x17))) {
                            titan_runtime_array_type_error(L, 6, LUA_TNUMFLT, rawtt(x17));
                        }
                        lua_Number x18 = fltvalue(x17);
                        lua_Number x19 = x6 + x18;
                        x6 = x19;
                    }
                    x11 = intop(+, x11, x14);
                }
            }
            x7 = intop(+, x7, x9);
        }
        return x6;
    }
}

static int function_sum_lua(lua_State *L)
{
    lua_checkstack(L, 1);
    CClosure * x1 = clCvalue(s2v(L->ci->func));
    Table * x2 /* upvalue table */ = hvalue(&x1->upvalue[0]);
    TValue * x3 /* upvalue array */ = x2->array;
    (void)x3;
    StackValue* x4 = L->ci->func;
    int x5 /* nargs */ = cast_int(L->top - (x4 + 1));
    if (TITAN_UNLIKELY(x5 != 2)) {
        titan_runtime_arity_error(L, 2, x5);
    }
    TValue* x6 = s2v(x4 + 1);
    if (TITAN_UNLIKELY(!ttistable(x6))) {
        titan_runtime_argument_type_error(L, "arr", 2, LUA_TTABLE, x6);
    }
    TValue* x7 = s2v(x4 + 2);
    if (TITAN_UNLIKELY(!ttisinteger(x7))) {
        titan_runtime_argument_type_error(L, "nrep", 2, LUA_TNUMINT, x7);
    }
    Table * x8 = hvalue(s2v(x4 + 1));
    lua_Integer x9 = ivalue(s2v(x4 + 2));
    lua_Number x10 /* ret */ = function_sum_titan(L, x8, x9);
    setfltvalue(s2v(L->top), x10);
    api_incr_top(L);
    return 1;
}

int luaopen_benchmarks_sum_hash(lua_State *L)
{
    lua_checkstack(L, 4);
    /* Allocate upvalue table */
    /* ---------------------- */
    Table * x1 = luaH_new(L);
    luaH_resizearray(L, x1, 3);
    TValue * x2 = x1->array;
    /* Initialize upvalues */
    /* ------------------- */
    TString * x3 = luaS_new(L, "__index");
    setsvalue(L,  &x2[0] , x3);
    if (isblack(obj2gco(x1)) && iswhite(obj2gco(x3))) {
        luaC_barrierback_(L, obj2gco(x1));
    }
    TString * x4 = luaS_new(L, "__metatable");
    setsvalue(L,  &x2[1] , x4);
    if (isblack(obj2gco(x1)) && iswhite(obj2gco(x4))) {
        luaC_barrierback_(L, obj2gco(x1));
    }
    /* sum */
    CClosure* x5 = luaF_newCclosure(L, 1);
    x5->f = function_sum_lua;
    sethvalue(L, &x5->upvalue[0], x1);
    TValue x6; setclCvalue(L, &x6, x5);
    setobj(L,  &x2[2] , &x6);
    if (iscollectable(&x6) && isblack(obj2gco(x1)) && iswhite(gcvalue(&x6))) {
        luaC_barrierback_(L, obj2gco(x1));
    }
    /* Create exports table */
    /* -------------------- */
    StackValue* x7 = L->top;
    sethvalue(L, s2v(x7), x1); x7++;
    L->top = x7;
    lua_createtable(L, 0, 1);
    lua_pushstring(L, "sum");
    setobj(L, s2v(L->top),  &x2[2] ); api_incr_top(L);
    lua_settable(L, -3);
    return 1;
}

